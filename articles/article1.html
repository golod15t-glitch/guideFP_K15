<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Статья</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

    body {
      font-family: "Inter", sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .content-editable {
      min-height: 300px;
      outline: none;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid transparent;
      transition: border-color 0.3s;
    }
    .content-editable[contenteditable="true"] {
      border-color: #4f46e5;
      background-color: #ffffff;
    }
    .editor-toolbar {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 0.5rem;
      display: none;
      gap: 0.5rem;
    }
    .editor-toolbar.active {
      display: flex;
    }
    .tool-btn {
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      border: 1px solid transparent;
      transition: background-color 0.2s, border-color 0.2s;
      background: #e0e7ff;
      color: #4338ca;
      font-size: 1rem;
    }
    .tool-btn:hover {
      background-color: #c7d2fe;
      border-color: #4338ca;
    }
    #adminModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #adminModal.active {
      visibility: visible;
      opacity: 1;
    }
    #adminModal .modal-content {
      background: white;
      padding: 1.5rem;
      border-radius: 0.75rem;
      max-width: 400px;
      width: 100%;
      box-sizing: border-box;
    }
    #adminError {
      color: red;
      margin-top: 0.5rem;
      display: none;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- Админский модал -->
  <div id="adminModal">
    <div class="modal-content">
      <h2>Доступ к редактированию</h2>
      <p>Введите код доступа администратора:</p>
      <input
        id="adminCodeInput"
        type="password"
        placeholder="Код доступа"
        style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; font-size: 1rem;"
      />
      <div id="adminError">Неверный код!</div>
      <button id="adminSubmitBtn" style="margin-top: 1rem; width: 100%; padding: 0.5rem; font-size: 1rem;">
        Подтвердить
      </button>
    </div>
  </div>

  <!-- Панель инструментов редактора -->
  <div id="editorToolbar" class="editor-toolbar">
    <button class="tool-btn" title="Жирный" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
    <button class="tool-btn" title="Курсив" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
    <button class="tool-btn" title="Подчёркивание" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
    <button class="tool-btn" title="Список" onclick="formatText('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
    <button class="tool-btn" title="Нумерованный список" onclick="formatText('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
    <button class="tool-btn" title="Вставить изображение" onclick="addImage()"><i class="fas fa-image"></i></button>
  </div>

  <!-- Заголовок статьи -->
  <div style="max-width: 800px; margin: 2rem auto 1rem; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center;">
    <h1 id="articleTitle" contenteditable="false" style="margin:0; font-size: 2.5rem; font-weight: 700;">
      Загрузка...
    </h1>
    <div>
      <button id="editBtn" style="font-size:1.25rem; padding: 0.5rem 1rem; cursor:pointer;">
        <i class="fas fa-pencil-alt"></i> Редактировать
      </button>
      <button id="saveBtn" style="font-size:1.25rem; padding: 0.5rem 1rem; cursor:pointer; display:none;">
        <i class="fas fa-save"></i> Сохранить
      </button>
    </div>
  </div>

  <!-- Контент статьи -->
  <div
    id="articleContent"
    class="content-editable"
    contenteditable="false"
    style="max-width: 800px; margin: 0 auto 3rem; background: white;"
  >
    <p>Загрузка...</p>
  </div>

  <script>
    const ADMIN_CODE = "123";

    const adminModal = document.getElementById("adminModal");
    const adminCodeInput = document.getElementById("adminCodeInput");
    const adminError = document.getElementById("adminError");
    const adminSubmitBtn = document.getElementById("adminSubmitBtn");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const articleContent = document.getElementById("articleContent");
    const articleTitle = document.getElementById("articleTitle");
    const editorToolbar = document.getElementById("editorToolbar");

    let isAdmin = false;

    function showAdminModal() {
      adminModal.classList.add("active");
      adminCodeInput.value = "";
      adminError.style.display = "none";
      adminCodeInput.focus();
    }

    function hideAdminModal() {
      adminModal.classList.remove("active");
    }

    adminSubmitBtn.addEventListener("click", () => {
      if (adminCodeInput.value === ADMIN_CODE) {
        isAdmin = true;
        sessionStorage.setItem("isAdmin", "true");
        hideAdminModal();
        enableEditing();
      } else {
        adminError.style.display = "block";
      }
    });

    function enableEditing() {
      articleContent.contentEditable = "true";
      articleTitle.contentEditable = "true";
      editorToolbar.classList.add("active");
      editBtn.style.display = "none";
      saveBtn.style.display = "inline-block";
      articleContent.focus();
    }

    function disableEditing() {
      articleContent.contentEditable = "false";
      articleTitle.contentEditable = "false";
      editorToolbar.classList.remove("active");
      editBtn.style.display = "inline-block";
      saveBtn.style.display = "none";
    }

    function formatText(command, value = null) {
      document.execCommand(command, false, value);
      articleContent.focus();
    }

    function addImage() {
      const url = prompt("Введите URL изображения", "https://");
      if (url) {
        formatText("insertImage", url);
      }
    }

    editBtn.addEventListener("click", () => {
      if (isAdmin) {
        enableEditing();
      } else {
        showAdminModal();
      }
    });

    // Просто пример — замените реальной загрузкой
    function loadArticle() {
      articleTitle.innerText = "Моя первая статья";
      articleContent.innerHTML = "<p>Здесь ваш контент...</p>";
    }

    // Функция для скачивания всей страницы с обновлённым текстом статьи
    function saveFullPage() {
      saveBtn.disabled = true;
      saveBtn.innerHTML = "Подготавливаю файл...";

      try {
        // Получаем весь html страницы
        const docHtml = document.documentElement.outerHTML;

        // Создаём временный div для парсинга
        const parser = new DOMParser();
        const doc = parser.parseFromString(docHtml, 'text/html');

        // Заменяем содержимое заголовка
        const h1 = doc.getElementById('articleTitle');
        if(h1) h1.textContent = articleTitle.innerText.trim();

        // Заменяем содержимое статьи
        const content = doc.getElementById('articleContent');
        if(content) content.innerHTML = articleContent.innerHTML;

        // Превращаем обратно в строку
        const updatedHtml = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;

        // Создаем Blob и ссылку на скачивание
        const blob = new Blob([updatedHtml], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;

        const filename = articleTitle.innerText.trim()
          .replace(/\s+/g, '_')
          .replace(/[^\w\-]/g, '') || 'article';

        a.download = filename + ".html";

        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        alert("Файл страницы успешно сохранён!");
        disableEditing();
      } catch(err) {
        alert("Ошибка при сохранении файла: " + err.message);
        console.error(err);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<i class="fas fa-save"></i> Сохранить`;
      }
    }

    saveBtn.addEventListener('click', saveFullPage);

    window.addEventListener("DOMContentLoaded", () => {
      if(sessionStorage.getItem("isAdmin") === "true") {
        isAdmin = true;
        enableEditing();
      }
      loadArticle();
    });
  </script>
</body>
</html>
